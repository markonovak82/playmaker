function Field(){this.render()}function Formation(a){pm.players={center:new Player({color:"yellow",label:"C",person:pm.people.tomaz}),qb:new Player({color:"yellow",label:"Q",person:pm.people.anton}),wrx:new Player({color:"yellow",label:"X",person:pm.people.klemen}),wry:new Player({color:"yellow",label:"Y",person:pm.people.uros}),slot:new Player({color:"yellow",label:"S",person:pm.people.marko})};var b=a.start.split(" ");b="own"===b[0]?60-parseInt(b[1],10):10+parseInt(b[1],10),this.update(a.name,b,a.side,a.qb),this.render()}function Person(a){if(a)for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])}function Play(a,b){for(var c in pm.players)b[c]&&(pm.players[c].route=new Route(b[c],pm.players[c]),a&&pm.players[c].route.render())}function Player(a){if(a)for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.section=0,this.time=0,this.speedFactor=170,this.accelerationFactor=240}function Playmaker(){this.$field=$("#field-canvas"),this.fieldCtx=this.$field[0].getContext("2d"),this.$players=$("#players-canvas"),this.playersCtx=this.$players[0].getContext("2d"),this.$formationBtn=$("#formation"),this.$playBtn=$("#play"),this.$sideBtn=$("#side"),this.$qbBtn=$("#qb"),this.$positionBtn=$("#position"),this.$setBtn=$("#set"),this.$animateBtn=$("#animate"),this.tick=this.tick.bind(this),this.set=this.set.bind(this),this.animate=this.animate.bind(this),this.people={},this.players={},this.animating=!1,this.playersLoaded=!1,this.formationsLoaded=!1}function Route(a,b){this.name=a,this.player=b,a&&this[a](b)}Field.prototype.render=function(){this.paintEndZones(),this.paintGrid(),this.paintFieldLines()},Field.prototype.paintEndZones=function(){var a=pm.fieldCtx;a.fillStyle="rgba(0, 0, 0, 0.15)",a.rect(0,0,500,200),a.rect(0,1200,500,1400),a.fill()},Field.prototype.paintGrid=function(){var a;for(a=20;1400>=a;a+=20)this.line({sx:0,sy:a+.5,ex:500,ey:a+.5,dashed:"grid",color:"rgba(255, 255, 255, 0.5)",width:1});for(a=20;500>=a;a+=20)this.line({sx:a+.5,sy:0,ex:a+.5,ey:1400,dashed:"grid",color:"rgba(255, 255, 255, 0.5)",width:1})},Field.prototype.paintFieldLines=function(){for(var a=200;1200>=a;a+=100)this.line({sx:0,sy:a+.5,ex:500,ey:a+.5,dashed:300===a||1100===a?"norunning":!1,color:"rgba(255, 255, 255, "+(a>300&&700>a||a>700&&1100>a?.2:1)+")",width:3});this.line({sx:230,sy:440.5,ex:270,ey:440.5,dashed:!1,color:"rgba(255, 255, 255, 1)",width:3}),this.line({sx:230,sy:960.5,ex:270,ey:960.5,dashed:!1,color:"rgba(255, 255, 255, 1)",width:3})},Field.prototype.line=function(a){var b=pm.fieldCtx;"grid"===a.dashed?b.setLineDash([2,2]):"norunning"===a.dashed?(b.setLineDash([10,10]),b.lineDashOffset=5):b.setLineDash([]),b.beginPath(),b.moveTo(a.sx,a.sy),b.lineTo(a.ex,a.ey),b.lineWidth=a.width,b.strokeStyle=a.color,b.stroke(),b.closePath()},Formation.prototype.update=function(a,b,c,d){for(var e in pm.players){var f=0,g=0,h=pm.formations[a].positions[e];"qb"===e?("object"==typeof h.x&&(f=h.x[d]),"object"==typeof h.y&&(g=h.y[d])):("object"==typeof h.x&&(f=h.x[c]),"object"==typeof h.y&&(g=h.y[c])),pm.players[e].setPosition(250+(f||h.x),20*b+(g||h.y))}},Formation.prototype.render=function(){for(var a in pm.players)pm.players[a].render()},Player.prototype.update=function(a){if(this.route){this.time+=a;var b=this.position.x+this.route.sections[this.section].x,c=this.position.y+this.route.sections[this.section].y,d=this.accelerationFactor*(this.person.acceleration/100),e=this.speedFactor*(this.person.speed/100),f=Math.min(d*(this.time/1e3),e),g=f*(a/1e3),h=b>this.position.x,i=c>this.position.y;b!==this.position.x&&(this.x=Math[h?"min":"max"](this.x+g*(h?1:-1),b)),c!==this.position.y&&(this.y=Math[i?"min":"max"](this.y+g*(i?1:-1),c))}},Player.prototype.render=function(){var a=pm.playersCtx;a.beginPath(),a.arc(this.x,this.y,10,0,2*Math.PI,!1),a.fillStyle=this.color,a.fill(),a.closePath(),a.font="9px Arial",a.fillStyle="rgba(0, 0, 0, 1)",a.strokeStyle="rgba(0, 0, 0, 1)",a.lineWidth=1,a.stroke(),a.fillText(this.label,this.x-3,this.y+4)},Player.prototype.setPosition=function(a,b){this.position={x:a,y:b},this.x=a,this.y=b},Playmaker.prototype.init=function(){this.playersLoaded||$.getJSON("/people.json",function(a){a.forEach(function(a){this.people[a.id]=new Person({name:a.name,speed:a.speed,acceleration:a.acceleration})},this),this.playersLoaded=!0}.bind(this)),this.formationsLoaded||$.getJSON("/formations.json",function(a){this.formations=a;for(var b in a)this.$formationBtn.append($("<option></option>").attr("value",b).text(b));this.formationsLoaded=!0}.bind(this)),this.$setBtn.click(this.set),this.$animateBtn.click(this.animate),this.field=new Field},Playmaker.prototype.set=function(){(this.playersLoaded||this.formationsLoaded)&&(this.reset(),this.formation=new Formation({name:this.$formationBtn.val(),side:this.$sideBtn.val(),qb:this.$qbBtn.val(),start:this.$positionBtn.val()}),this.play=new Play(!0,{qb:null,center:"up",wrx:"up",wry:"up",slot:"up"}))},Playmaker.prototype.animate=function(){this.animating=!0,this.tick()},Playmaker.prototype.reset=function(){this.animating=!1,this.field=null,this.people={},this.players={},this.formation=null,this.play=null,this.clear(),this.init()},Playmaker.prototype.tick=function(){var a,b;return this.animating?(requestAnimationFrame(this.tick),b=new Date,null===this.lastUpdateTime&&(this.lastUpdateTime=b),a=b-this.lastUpdateTime,this.update(a),this.render(),void(this.lastUpdateTime=b)):void(this.lastUpdateTime=null)},Playmaker.prototype.update=function(a){for(var b in this.players)this.players[b].update(a)},Playmaker.prototype.render=function(){this.clear(),this.field.render();for(var a in this.players)this.players[a].render()},Playmaker.prototype.clear=function(){this.fieldCtx.clearRect(0,0,this.$field.width(),this.$field.height()),this.playersCtx.clearRect(0,0,this.$players.width(),this.$players.height())},Route.prototype.render=function(){},Route.prototype.quickIn=function(a){var b=a.x<250;this.coords=[{x:a.x,y:a.y-40},{x:a.x+(b?20:-20),y:a.y-60},{x:a.x+(b?480-a.x:-a.x+20),y:a.y-60}]},Route.prototype.shortCurl=function(a){var b=a.x<250;this.coords=[{x:a.x,y:a.y-60},{x:a.x+(b?100:-100),y:a.y-160},{x:a.x+(b?100:-100),y:a.y-140}]},Route.prototype.skinyPost=function(a){var b=a.x<250;this.coords=[{x:a.x,y:a.y-100},{x:a.x+(b?60:-60),y:a.y-280}]},Route.prototype.out=function(a){var b=a.x<250;this.fn=function(c,d,e){var f,g;return d>a.position.y-100?(f=c,g=d-e):(a.newX=Math.min(c+(b?-e:e),490),g=d),{x:f,y:g}}},Route.prototype.up=function(a){this.sections=[{x:0,y:-a.y+10,speed:0,delay:0}]};